#!/usr/bin/env bash
# Malware Analysis Lab (REMnux-based) installer

set -e

echo "=================================================="
echo "   USBFREEDOM Malware Analysis Lab Setup"
echo "=================================================="
echo

# Function to check internet connectivity
check_internet() {
    echo "[+] Checking Internet connectivity..."
    if ping -c 1 1.1.1.1 >/dev/null 2>&1; then
        echo "[+] Internet connection detected."
        return 0
    else
        echo "[-] No Internet connection. Please connect and try again."
        return 1
    fi
}

# Function to install system dependencies
install_system_deps() {
    echo "[+] Installing system dependencies..."
    sudo apt-get update >/dev/null 2>&1
    sudo apt-get install -y curl wget git python3-pip docker.io docker-compose >/dev/null 2>&1
    sudo systemctl enable docker
    sudo systemctl start docker
    sudo usermod -aG docker $USER
    echo "[+] System dependencies installed"
}

# Function to install analysis tools
install_analysis_tools() {
    echo "[+] Installing malware analysis tools..."
    
    # Install Python tools
    pip3 install --user yara-python pefile capstone-engine r2pipe >/dev/null 2>&1
    
    # Install static analysis tools
    sudo apt-get install -y binwalk foremost xxd hexedit radare2 >/dev/null 2>&1
    
    # Install network analysis tools
    sudo apt-get install -y wireshark tcpdump ngrep >/dev/null 2>&1
    
    echo "[+] Analysis tools installed"
}

# Function to setup ghidra
setup_ghidra() {
    echo "[+] Setting up Ghidra..."
    
    mkdir -p ~/tools
    cd ~/tools
    
    # Download Ghidra if not present
    if [ ! -d "ghidra_*" ]; then
        echo "  Downloading Ghidra..."
        wget -q https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.0.3_build/ghidra_11.0.3_PUBLIC_20240410.zip
        unzip -q ghidra_11.0.3_PUBLIC_20240410.zip
        rm ghidra_11.0.3_PUBLIC_20240410.zip
    fi
    
    # Create launcher script
    cat > ~/tools/ghidra-launcher.sh << 'EOF'
#!/bin/bash
cd ~/tools/ghidra_*
./ghidraRun
EOF
    chmod +x ~/tools/ghidra-launcher.sh
    
    echo "[+] Ghidra setup complete"
}

# Function to setup YARA rules
setup_yara() {
    echo "[+] Setting up YARA rules..."
    
    mkdir -p ~/malware-analysis/yara-rules
    cd ~/malware-analysis/yara-rules
    
    # Download community YARA rules
    if [ ! -d "yara-rules" ]; then
        git clone https://github.com/Yara-Rules/rules.git yara-rules 2>/dev/null || true
    fi
    
    echo "[+] YARA rules installed"
}

# Function to setup analysis workspace
setup_workspace() {
    echo "[+] Setting up analysis workspace..."
    
    mkdir -p ~/malware-analysis/{samples,reports,tools,scripts}
    
    # Create useful analysis scripts
    cat > ~/malware-analysis/scripts/quick-analysis.sh << 'EOF'
#!/bin/bash
# Quick malware analysis script

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <malware_sample>"
    exit 1
fi

SAMPLE="$1"
echo "=== Quick Analysis Report ===" 
echo "Sample: $SAMPLE"
echo "Date: $(date)"
echo

echo "=== File Information ==="
file "$SAMPLE"
ls -la "$SAMPLE"
echo

echo "=== Hashes ==="
md5sum "$SAMPLE"
sha1sum "$SAMPLE"
sha256sum "$SAMPLE"
echo

echo "=== Strings (first 50) ==="
strings "$SAMPLE" | head -50
echo

echo "=== YARA Scan ==="
if command -v yara >/dev/null 2>&1; then
    yara ~/malware-analysis/yara-rules/yara-rules/*/*.yar "$SAMPLE" 2>/dev/null || echo "No YARA matches found"
else
    echo "YARA not installed"
fi
EOF

    chmod +x ~/malware-analysis/scripts/quick-analysis.sh
    
    echo "[+] Analysis workspace created"
}

# Function to show completion message
show_completion() {
    echo
    echo "=================================================="
    echo "   Malware Analysis Lab Setup Complete!"
    echo "=================================================="
    echo
    echo "Installed tools:"
    echo "  • Static analysis: Ghidra, radare2, binwalk"
    echo "  • Python tools: yara-python, pefile, capstone"
    echo "  • Network analysis: Wireshark, tcpdump"
    echo "  • Utilities: hexedit, xxd, foremost"
    echo
    echo "Analysis workspace created at: ~/malware-analysis/"
    echo
    echo "Quick start commands:"
    echo "  ~/tools/ghidra-launcher.sh                    # Launch Ghidra"
    echo "  ~/malware-analysis/scripts/quick-analysis.sh sample.exe  # Quick analysis"
    echo "  yara ~/malware-analysis/yara-rules/yara-rules/*/*.yar sample.exe  # YARA scan"
    echo
    echo "⚠️  WARNING: Only analyze malware in isolated environments!"
    echo "   Use VMs, containers, or air-gapped systems."
    echo
}

# Main execution
main() {
    if ! check_internet; then
        exit 1
    fi
    
    install_system_deps
    install_analysis_tools
    setup_ghidra
    setup_yara
    setup_workspace
    show_completion
    
    echo "Note: You may need to log out and back in for Docker group changes to take effect."
}

# Run main function
main "$@"
