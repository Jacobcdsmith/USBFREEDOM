#!/usr/bin/env bash
# Penetration Testing Kit (Kali-based) installer

set -e

echo "=================================================="
echo "   USBFREEDOM Penetration Testing Kit Setup"
echo "=================================================="
echo

# Function to check if we're on a Debian-based system
check_system() {
    if ! command -v apt-get >/dev/null 2>&1; then
        echo "[-] This script is designed for Debian-based systems (Kali, Ubuntu, etc.)"
        echo "    Please install tools manually on your system"
        return 1
    fi
}

# Function to check internet connectivity
check_internet() {
    echo "[+] Checking Internet connectivity..."
    if ping -c 1 1.1.1.1 >/dev/null 2>&1; then
        echo "[+] Internet connection detected."
        return 0
    else
        echo "[-] No Internet connection. Please connect and try again."
        return 1
    fi
}

# Function to update package lists
update_packages() {
    echo "[+] Updating package lists..."
    if ! sudo apt-get update >/dev/null 2>&1; then
        echo "[-] Failed to update package lists"
        return 1
    fi
    echo "[+] Package lists updated successfully"
}

# Function to install core tools
install_core_tools() {
    echo "[+] Installing core penetration testing tools..."
    
    local tools=(
        "nmap"              # Network mapping
        "masscan"           # Fast port scanner  
        "nikto"             # Web vulnerability scanner
        "dirb"              # Web directory brute forcer
        "gobuster"          # Directory/file brute forcer
        "sqlmap"            # SQL injection tool
        "john"              # Password cracker
        "hashcat"           # Advanced password recovery
        "hydra"             # Network login cracker
        "netcat-openbsd"    # Swiss army knife for TCP/IP
        "socat"             # Multipurpose relay
        "curl"              # Command line web tool
        "wget"              # Web downloader
        "git"               # Version control
        "python3-pip"       # Python package manager
    )
    
    for tool in "${tools[@]}"; do
        echo "  Installing: $tool"
        if ! sudo apt-get install -y "$tool" >/dev/null 2>&1; then
            echo "    [-] Failed to install $tool"
        else
            echo "    [+] $tool installed successfully"
        fi
    done
}

# Function to install Python tools
install_python_tools() {
    echo "[+] Installing Python-based tools..."
    
    local python_tools=(
        "impacket"          # Network protocols library
        "pwntools"          # CTF framework  
        "requests"          # HTTP library
        "beautifulsoup4"    # HTML/XML parser
        "scapy"             # Packet manipulation
        "paramiko"          # SSH library
    )
    
    for tool in "${python_tools[@]}"; do
        echo "  Installing: $tool"
        if ! pip3 install "$tool" >/dev/null 2>&1; then
            echo "    [-] Failed to install $tool"
        else
            echo "    [+] $tool installed successfully"
        fi
    done
}

# Function to setup environment
setup_environment() {
    echo "[+] Setting up environment..."
    
    # Create useful directories
    mkdir -p ~/tools ~/wordlists ~/scripts
    
    # Download common wordlists
    echo "  Downloading SecLists wordlists..."
    if [ ! -d ~/wordlists/SecLists ]; then
        git clone https://github.com/danielmiessler/SecLists.git ~/wordlists/SecLists 2>/dev/null || true
    fi
    
    echo "[+] Environment setup complete"
}

# Function to show completion message
show_completion() {
    echo
    echo "=================================================="
    echo "   Penetration Testing Kit Setup Complete!"
    echo "=================================================="
    echo
    echo "Installed tools:"
    echo "  • Network scanning: nmap, masscan"
    echo "  • Web testing: nikto, dirb, gobuster, sqlmap"
    echo "  • Password attacks: john, hashcat, hydra"
    echo "  • Python tools: impacket, pwntools, scapy"
    echo "  • Wordlists: SecLists collection"
    echo
    echo "Quick start commands:"
    echo "  nmap -sS target_ip          # SYN scan"
    echo "  gobuster dir -u http://target -w ~/wordlists/SecLists/Discovery/Web-Content/common.txt"
    echo "  sqlmap -u 'http://target/?id=1' --dbs"
    echo
    echo "Happy hacking! (Legally and ethically, of course)"
    echo
}

# Main execution
main() {
    if ! check_system; then
        exit 1
    fi
    
    if ! check_internet; then
        echo "Would you like to proceed with offline setup? (y/N)"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        update_packages
        install_core_tools
        install_python_tools
    fi
    
    setup_environment
    show_completion
}

# Run main function
main "$@"
