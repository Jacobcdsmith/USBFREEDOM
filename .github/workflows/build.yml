name: Build USB Images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolkit:
          - name: pentest-kit
            base_iso: kali-linux-rolling.iso
            iso_url: https://cdimage.kali.org/kali-latest/kali-linux-rolling-live-amd64.iso
          - name: malware-analysis
            base_iso: remnux-focal.ova
            iso_url: https://docs.remnux.org/distro/get#download-virtual-appliance
          - name: data-science
            base_iso: ubuntu-24.04-live-server.iso
            iso_url: https://releases.ubuntu.com/24.04/ubuntu-24.04-live-server-amd64.iso
          - name: mobile-dev
            base_iso: manjaro-xfce-minimal.iso
            iso_url: https://download.manjaro.org/xfce/21.3.7/manjaro-xfce-21.3.7-minimal-220618-linux515.iso
          - name: sdr-comm
            base_iso: kali-linux-rolling.iso
            iso_url: https://cdimage.kali.org/kali-latest/kali-linux-rolling-live-amd64.iso
          - name: firmware-reverse
            base_iso: debian-12-netinst.iso
            iso_url: https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-12.8.0-amd64-netinst.iso
          - name: ics-scada
            base_iso: kali-linux-rolling.iso
            iso_url: https://cdimage.kali.org/kali-latest/kali-linux-rolling-live-amd64.iso
          - name: os-installer
            base_iso: ventoy.tar.gz
            iso_url: https://github.com/ventoy/Ventoy/releases/latest/download/ventoy-1.0.99-linux.tar.gz

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full genisoimage

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Run tests
      run: pytest -q

    - name: Download base ISO
      run: |
        mkdir -p base_iso
        wget -O base_iso/${{ matrix.toolkit.base_iso }} ${{ matrix.toolkit.iso_url }}

    - name: Build USB image
      run: |
        chmod +x build.sh
        ./build.sh base_iso/${{ matrix.toolkit.base_iso }} ${{ matrix.toolkit.name }}.img

    - name: Calculate checksums
      run: |
        sha256sum ${{ matrix.toolkit.name }}.img > ${{ matrix.toolkit.name }}.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.toolkit.name }}
        path: |
          ${{ matrix.toolkit.name }}.img
          ${{ matrix.toolkit.name }}.sha256

    # Stylish CLI interface and automation scripts will handle Internet connectivity and downloads on the built images.
